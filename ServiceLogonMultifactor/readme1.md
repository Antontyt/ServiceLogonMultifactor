1.  **[Назначение программы]{.smallcaps}**

ServiceLogonMultiFactor (SLMF) бесплатный софт позволяющий подключить
второй фактор аутентификации пользователей заходящих на компьютер как
локально так и по протоколу RDP. Второй фактор посылается на мессенджер
Telegram в виде удобного сообщения с кнопками разрешить/запретить.

Сервис SLMF не может предотвратить вход пользователя в систему но в
случае не получения ответа в течении периода указанного в п.3.5 или
сразу по нажатию кнопки отключить пользователь будет отключен.

2.  **[Установка SLMF]{.smallcaps}**

Установка возможна несколькими способами

1.  Стандартной утилитой InstallUtil.exe с параметрами по умолчанию

> Установка
> *C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\InstallUtil.exe
> \<your folder>ServiceLogonMultifactor.exe*
>
> *Первый запуск*
>
> *Удаление
> C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\InstallUtil.exe
> /u \<your folder>ServiceLogonMultifactor.exe*

2.  Инсталлятором

3.  Инсталлятором с интерфейсом

4.  Установка сервиса с нестандартным именем и описанием

> По умолчанию сервис будет называться \"ServiceLogonMultifactor\" с
> описанием \"Service for logging of logon and unlock events and send
> notification to telegram bot\" для задания другого название и описание
> можно установить с помощью InstallUtil.exe с параметрами /ServiceName=
> и /description=

*C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\InstallUtil.exe
/ServiceName="service101" /description="test service 101"
\<your_folder>ServiceLogonMultifactor.exe*

![](media/image1.png){width="7.75in" height="0.37777777777777777in"}

При удалении так же необходимо указать имя сервиса

*C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\InstallUtil.exe
/ServiceName="service101" /u \<your_folder>ServiceLogonMultifactor.exe*

3.  **[Общие настройки]{.smallcaps}**

Файл настроек Service.Config.xml должен находится рядом с исполнительным
файлом. Это xml с простой структурой. Используйте true и false без
больших букв. В данной версии не производится автоматическое приведение.

Настройки сервиса (\<ServiceConfig/>):

1.  **botId**=\"0000000000:AAAaaBBBBBBbbbbCCCCCccccccDDDDdddd\"

> ИД бота и ключ получается при создании бота инструкция ниже

2.  **chatId**=\"1000000\"

> Чат ИД администратора (код телефонного номера в телеграмме) на этот
> чат приходят сообщения о запуске и остановке сервиса, логине
> пользователя которого нет в списке, а так же с этого чат ИД можно
> посылать команды на отключение сессий и получение информации.

3.  **DetailInfoOnServiceStart**=\"false\"

> Определяет посылать ли результаты команд systeminfo,tasklist и
> конфигурационный файл администратору ( п.1.2) при старте сервиса.
>
> Результаты этих комманд всегда можно получить выполнив команду \<имя
> компьютера/all> info / config

4.  **daysOldDeliteLogs**=\"0\"

5.  **waitForAnswerSec**=\"20\"

> время в секундах во время которого сервис ждет ответ. По истечению
> ответ игнорируется.

6.  **sendMessageBeforeDisconnectSec**=\"15\"

> время в секундах до отключения сессии когда начинает выводится
> сообщение с помощью команды msg.exe \<session ID> \<text>

7.  **disconnectIfNoAnswer**=\"True\"

> отключать сессию если не получен ответ

8.  **notDisconnectIP**=\"console\"

> список IP при подключении с которых не происходит отключение. У
> каждого пользователя свой список, поэтому данный параметр работает
> либо для пользователей, которым запрещено меня собственные списки либо
> для пользователей, которых нет в списке. Данный параметр меняется
> программой по нажатию на третью кнопку в сообщении "Enable & remIP" /
> "Disconnect & rem IP"

9.  **CommandReadIntervalSec**=\"30\"

> Интервал, по которому происходит чтение запросов из телеграмма в
> фоновом режиме (запросы на отключение или получения информации) а так
> же чтение и сохранение информации в данном файле.

10. **SingleServiceOnTheBot**=\"false\"

> Задайте этот параметр true если Телеграм бот с эти ИД используется
> только на одном компьютере. В этом случае после чтения команд они
> будут удалятся из Телеграмма, что сэкономит ресурсы. Если один
> Телеграм бот используется несколькими сервисами, то надо оставить его
> false, чтобы все сервисы могли прочитать команду.

11. **ClearTelegramRequestsAfterSeconds**=\"120\"

> Время, после которого удаляются старые команды если
> **SingleServiceOnTheBot**=\"true\" то этот параметр не имеет значение.
> Должен быть заведомо больше, чем **CommandReadIntervalSec**=\"30\" на
> других компьютерах, использующих тот же botId чтобы все остальные
> сервисы успели прочитать команду.

12. **LinesPerSessionInTaskList**=\"10\"

> Колличество строк на каждую сессию в результатах команды tasklist

13. **systemInfoOnStartFields**=\"OS Name;System Boot Time;Total
    > Physical Memory;Available Physical Memory;Domain\"

> Список заголовков полей из команды systeminfo.exe fo table которые
> будут присылаться при старте сервиса. Или по запросу \<имя
> компьютера/all> info

14. **systemInfoOnEventFields**=\"OS Name;System Boot Time;Total
    > Physical Memory;Available Physical Memory;Domain\"

> Список заголовков полей из команды systeminfo.exe fo table которые
> будут присылаться вместе с ответом на нажатие кнопки. Если
> пользователь администратор. Команда достсточно медленная и для
> ускорения реакции на нажатие кнопки лучше оставить этот параметр
> пустым.

15. **LOGON_TIME**\_**fieldName**=\"LOGON TIME\"

16. **USERNAME_fieldName**=\"USERNAME\"

17. **SESSIONNAME_fieldName**=\"SESSIONNAME\"

> Региональные настройки: надо выполнить команду quser и посмотреть
> название этих столбцов для вашего языка операционной системы.
> Пожалуйста, заметьте, что если вы изначально ставили английскую
> версию, а потом поменяли язык интерфейса то скорее всего система
> по-прежнему английская. Результат выполнения этой команды из под
> системного аккаунта можно увидеть в файле лога после запуска сервиса и
> первого логина(файл \\log\\full\\logfull-yyyy-mm-dd.txt)

18. **LastUpdateRecived**=\"45770444\"

19. **ThreIsNewChanges**=\"false\"

20. **LastConfigRead**=\"2021-05-26T10:57:07.54406+03:00\"

> Служебные поля редактируются программой.

4.  **[Настройки пользователей \<Users> \<user />
    \</Users>]{.smallcaps}**

    1.  **name**=\"user1\"

> имя пользователя как в результате выполнения команды quser (без
> домена)

2.  **chatId**=\"00000000\"

> Чат ИД данного пользователя, эти два параметра являются минимальными
> настройками остальные данные можно не заполнять, они будут взяты
> значения по умолчанию

3.  **waitForAnswerSec**=\"0\" 0-значение из общих настроек

4.  **sendMessageBeforeDisconnectSec**=\"0\" 0-значение из общих
    > настроек

5.  **notDisconnectIP**=\";console\"

6.  **CanChangeIP**=\"true\"

> Пользователь может редактировать список IP по умолчанию true

7.  **IsAdmin**=\"false\"

> Может ли пользователь посылать команды на отключение сессий и запрос
> информации о системе по умолчанию false

5.  **[Команды которые можно послать боту]{.smallcaps}**

    1.  Команда состоит из двух или трех частей с пробелом в качестве
        разделителя

        1.  Имя компьютера или all (все компьютеры)

        2.  Сама команда (dis, sys, quser, task, config, ver, inform)

        3.  Параметр только для dis номер - сессии

    2.  Dis (disconnect) номер сессии пример

    3.  sys (systeminfo) результат выполнения команды systeminfo.exe
        настройки в п.1.13

    4.  quser результат выполнения команды quser.exe

    5.  task (tasklist) результат выполнения команды tasklist.exe
        настройки в п.1.12

    6.  config текущая конфигурация (из файла Service.Config.xml)

    7.  ver (version) версия запущенного сервиса и его uptime в часах

    8.  Inform (information )посылает в одном сообщении результаты всех
        трех комманд quser.exe,systeminfo.exe,tasklist.exe

    9.  Примеры

        1.  ws-01 dis 3 отключит 3 сессию на компе ws-01

        2.  ws-01 sys пришлет результаты systeminfo c ws-01

        3.  All sys тоже самое со всех компьютеров

        4.  ws-01 quser, all quser, ws-01 config, all config, all ver и
            т.д.

    10. разрешения определяются параметром IsAdmin (п.2.7) если true то
        > все можно делать, false сервис ответит что пользователь не
        > админ, нет такого пользователя (chatid) в конфиге не будет ни
        > какого ответа.
